<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Register — BinPay</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1: #061223;
      --bg-2: #071a2a;
      --accent: #06b6d4;
      --accent-2: #0891b2;
      --muted: #9fb0c6;
      --text: #e6eef6;
      --radius: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,var(--bg-1) 0%, var(--bg-2) 100%);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* single column container */
    .container{
      width:100%;
      max-width:520px;
      margin:0 auto;
      padding:8px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: var(--radius);
      padding:20px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.04);
    }

    h1{margin:0 0 8px;font-size:24px}
    p.lead{margin:0 0 12px;color:var(--muted);line-height:1.45;font-size:15px}

    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input{
      padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);
      background:rgba(255,255,255,0.02);color:var(--text);outline:none;font-size:15px;width:100%;
    }
    input::placeholder{ color: rgba(230,238,246,0.45) }
    input:focus{ box-shadow: 0 8px 22px rgba(6,182,212,0.08); border-color: rgba(6,182,212,0.28); transform: translateY(-1px) }

    .field{ position:relative }

    .eye-btn{
      position:absolute; right:10px; top:50%; transform:translateY(-50%);
      height:34px; width:34px; display:inline-grid; place-items:center;
      background:transparent; border-radius:8px; border:none; cursor:pointer; color:var(--muted);
    }

    .row{display:flex;gap:10px;margin-top:12px}
    .btn{
      flex:1;padding:12px;border-radius:12px;border:0;
      background:linear-gradient(90deg,var(--accent),var(--accent-2));
      color:#042027;font-weight:700;cursor:pointer;font-size:15px;
      box-shadow: 0 8px 20px rgba(6,182,212,0.12);
    }
    .btn.secondary{
      background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);min-width:120px;font-weight:600;
    }

    .muted{color:var(--muted);font-size:13px;margin-top:12px}

    /* keep server element in DOM but hidden (so JS that reads it won't break) */
    .server-line{ display:none; }

    #msg{ color:var(--muted); min-height:18px; margin-top:8px; font-size:13px }

    @media (max-width:520px){
      body{padding:14px}
      .card{padding:16px}
      h1{font-size:20px}
      .row{flex-direction:column-reverse}
      .btn, .btn.secondary{ width:100% }
      .eye-btn{ right:8px; height:32px; width:32px }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" aria-labelledby="regTitle">
      <h1 id="regTitle">BinPay - Buat akun baru</h1>
      <p class="lead">Daftar untuk mendapatkan nomor account unik, lalu bisa deposit & transfer secara real-time.</p>

      <form id="regForm" onsubmit="return false" autocomplete="on" novalidate>
        <div>
          <label for="name">Nama lengkap</label>
          <input id="name" placeholder="Nama kamu" required />
        </div>

        <div style="margin-top:10px">
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="email@contoh.com" required />
        </div>

        <div style="margin-top:10px">
          <label for="pw1">Password</label>
          <div class="field">
            <input id="pw1" type="password" placeholder="Minimal 6 karakter" required />
            <button type="button" class="eye-btn" data-target="pw1" aria-label="Tampilkan password" title="Tampilkan password">
              <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              <svg class="eye-closed" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="display:none">
                <path d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-7 0-11-7-11-7a21.79 21.79 0 0 1 5.17-5.94"></path>
                <path d="M1 1l22 22"></path>
                <path d="M9.88 9.88A3 3 0 0 0 14.12 14.12"></path>
              </svg>
            </button>
          </div>
        </div>

        <div style="margin-top:10px">
          <label for="pw2">Ulangi Password</label>
          <div class="field">
            <input id="pw2" type="password" placeholder="Ulangi password" required />
            <button type="button" class="eye-btn" data-target="pw2" aria-label="Tampilkan password" title="Tampilkan password">
              <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              <svg class="eye-closed" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="display:none">
                <path d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-7 0-11-7-11-7a21.79 21.79 0 0 1 5.17-5.94"></path>
                <path d="M1 1l22 22"></path>
                <path d="M9.88 9.88A3 3 0 0 0 14.12 14.12"></path>
              </svg>
            </button>
          </div>
        </div>

        <div class="row">
          <button class="btn" id="btnReg" type="button">Daftar</button>
        </div>

        <div class="muted">Sudah punya akun? <a href="/login.html" style="color:var(--accent);text-decoration:none;font-weight:600">Masuk</a></div>

        <div id="msg" aria-live="polite"></div>

        <!-- server element tetap ada untuk kompatibilitas JS, tapi disembunyikan -->
        <div class="server-line" aria-hidden="true">Server: <strong id="serverOrigin">loading...</strong></div>
      </form>
    </div>
  </div>

<script>
/* LOGIKA TIDAK DIUBAH. api tetap sama. */
const api = 'https://binpay.onrender.com/api';
const serverEl = document.getElementById('serverOrigin');
if(serverEl) serverEl.innerText = window.location.origin || 'http://localhost';

function setToken(t){ if(t) localStorage.setItem('token', t); else localStorage.removeItem('token'); }

async function parseJsonOrText(response) {
  const txt = await response.text();
  try { return { ok: response.ok, json: JSON.parse(txt), text: txt }; }
  catch (e) { return { ok: response.ok, json: null, text: txt }; }
}

async function doAutoLoginAndRedirect(account_number, password, msgEl){
  try{
    msgEl.innerText = 'Mencoba login otomatis...';
    const resLogin = await fetch(api + '/login', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ account_number, password })
    });

    const parsed = await parseJsonOrText(resLogin);
    if(!parsed.json){
      msgEl.innerText = 'Login otomatis gagal: respons bukan JSON. Cek rewrite / backend. Preview: ' + (parsed.text || '').slice(0,200);
      console.error('Auto-login unexpected response (not JSON):', parsed.text);
      return false;
    }

    const body = parsed.json;
    if(resLogin.ok && body.token){
      setToken(body.token);
      msgEl.innerText = 'Login otomatis berhasil — redirecting...';
      setTimeout(()=> { location.href = '/index.html'; }, 300);
      return true;
    } else {
      msgEl.innerText = 'Registrasi sukses tapi login otomatis gagal: ' + (body.error || JSON.stringify(body));
      return false;
    }
  }catch(e){
    console.error(e);
    msgEl.innerText = 'Login otomatis error: ' + (e.message || e);
    return false;
  }
}

async function register(e){
  if(e && typeof e.preventDefault === 'function') e.preventDefault();
  const owner_name = document.getElementById('name').value.trim();
  const email = document.getElementById('email').value.trim();
  const pw1 = document.getElementById('pw1').value;
  const pw2 = document.getElementById('pw2').value;
  const msgEl = document.getElementById('msg');

  if(!owner_name||!email||!pw1){ msgEl.innerText='Isi semua field'; return }
  if(pw1.length<6){ msgEl.innerText='Password minimal 6 karakter'; return }
  if(pw1!==pw2){ msgEl.innerText='Password tidak cocok'; return }

  msgEl.innerText='Mendaftar...';
  try{
    const res = await fetch(api + '/register', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({owner_name,email,password:pw1})
    });

    const parsed = await parseJsonOrText(res);
    if(!parsed.json){
      msgEl.innerText = 'Respons bukan JSON — cek rewrite / endpoint. Preview: ' + (parsed.text || '').slice(0,200);
      console.error('Register unexpected response (not JSON):', parsed.text);
      return;
    }
    const j = parsed.json;

    if(res.ok && j.account_number){
      msgEl.innerText = 'Terdaftar — nomor account: ' + j.account_number + '. Login otomatis...';
      await doAutoLoginAndRedirect(j.account_number, pw1, msgEl);
      return;
    } else {
      msgEl.innerText = j.error || (res.statusText || 'Registrasi gagal');
    }
  }catch(e){
    console.error(e);
    msgEl.innerText = e.message || 'Terjadi kesalahan';
  }
}

/* event listeners */
document.getElementById('btnReg').addEventListener('click', register);
document.getElementById('btnDemo').addEventListener('click', ()=> {
  document.getElementById('name').value='Demo User';
  document.getElementById('email').value='demo@test.com';
  document.getElementById('pw1').value='123456';
  document.getElementById('pw2').value='123456';
  document.getElementById('msg').innerText='Contoh terisi';
});
document.getElementById('regForm').addEventListener('submit', (e) => {
  e.preventDefault(); register();
});

/* Eye toggle (UI-only) */
(function(){
  function toggleFor(button){
    const targetId = button.getAttribute('data-target');
    if(!targetId) return;
    const input = document.getElementById(targetId);
    const eyeOpen = button.querySelector('.eye-open');
    const eyeClosed = button.querySelector('.eye-closed');
    let visible = false;
    button.addEventListener('click', () => {
      visible = !visible;
      if(visible){
        input.type = 'text';
        if(eyeOpen) eyeOpen.style.display = 'none';
        if(eyeClosed) eyeClosed.style.display = 'inline';
        button.setAttribute('aria-label','Sembunyikan password');
        button.title = 'Sembunyikan password';
      } else {
        input.type = 'password';
        if(eyeOpen) eyeOpen.style.display = 'inline';
        if(eyeClosed) eyeClosed.style.display = 'none';
        button.setAttribute('aria-label','Tampilkan password');
        button.title = 'Tampilkan password';
      }
      input.focus();
    });

    button.addEventListener('touchstart', () => {
      if(!visible){
        input.type = 'text';
        if(eyeOpen) eyeOpen.style.display = 'none';
        if(eyeClosed) eyeClosed.style.display = 'inline';
      }
    }, {passive:true});
    button.addEventListener('touchend', () => {
      if(!visible){
        input.type = 'password';
        if(eyeOpen) eyeOpen.style.display = 'inline';
        if(eyeClosed) eyeClosed.style.display = 'none';
      }
    }, {passive:true});
  }

  document.querySelectorAll('.eye-btn').forEach(btn => toggleFor(btn));
})();
</script>
</body>
</html>
